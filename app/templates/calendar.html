<div class="calendar-container">
    <div class="calendar-header">
        <button onclick="changeMonth(-1)">Previous</button>
        <h2 id="calendar-title"></h2>
        <button onclick="changeMonth(1)">Next</button>
    </div>
    <div class="calendar" id="calendar">
        <!-- Calendar cells will be injected here by JavaScript -->
    </div>
</div>

<!-- Reservation Modal for User -->
<div id="reservationModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('reservationModal')">&times;</span>
        <h2>Reserve Slot</h2>
        <form id="reservationForm" method="post" action="/reserve">
            <input type="hidden" id="datetime" name="datetime">
            Name: <input type="text" name="name" required><br>
            Phone: <input type="text" name="phone" required><br>
            Password: <input type="password" name="password" required><br>
            <button type="submit">Reserve</button>
        </form>
    </div>
</div>

<!-- Cancel Reservation Modal for User -->
<div id="cancelModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('cancelModal')">&times;</span>
        <h2>Cancel Reservation</h2>
        <form id="cancelForm" method="post" action="/cancel">
            <input type="hidden" id="cancel_reservation_id" name="reservation_id">
            Phone: <input type="text" name="phone" required><br>
            Password: <input type="password" name="password" required><br>
            <button type="submit">Cancel Reservation</button>
        </form>
    </div>
</div>

<!-- Confirmation Modal for Admin (Cancel Reservation) -->
<div id="adminCancelModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('adminCancelModal')">&times;</span>
        <h2>Confirm Cancellation</h2>
        <p id="adminReservationDetails"></p>
        <form id="adminCancelForm" method="post" action="/admin/cancel">
            <input type="hidden" id="admin_cancel_reservation_id" name="reservation_id">
            <button type="submit">Confirm Cancellation</button>
        </form>
    </div>
</div>

<!-- Confirmation Modal for Admin (Remove Available Slot) -->
<div id="adminRemoveSlotModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('adminRemoveSlotModal')">&times;</span>
        <h2 id="adminRemoveSlotTitle">Confirm Slot Removal</h2>
        <p id="adminRemoveSlotDetails"></p>
        <form id="adminRemoveSlotForm" method="post" action="/admin/delete_slot">
            <input type="hidden" id="admin_remove_slot_id" name="slot_id">
            <button type="submit">Confirm Removal</button>
        </form>
    </div>
</div>

<!-- Set Available Slot Modal for Admin -->
<div id="adminSetSlotModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('adminSetSlotModal')">&times;</span>
        <h2 id="adminSetSlotTitle">Set Available Slot</h2>
        <form id="adminSetSlotForm" method="post" action="/admin/settings" onsubmit="return validateSetSlotForm()">
            <input type="hidden" id="available_date" name="available_date">
            Time: <input type="time" name="available_time" required><br>
            Repeat: 
            <select name="repeat" id="repeat" onchange="toggleEndDate()">
                <option value="none">No Repeat</option>
                <option value="daily">Once a Day (Mon-Fri)</option>
                <option value="weekly">Once a Week</option>
                <option value="monthly">Once a Month</option>
            </select><br>
            <div id="end_date_field" style="display:none;">
                End Date for Repetition: <input type="date" name="end_date" id="end_date"><br>
            </div>
            <button type="submit">Set</button>
        </form>
    </div>
</div>

<script>
    const slots = {{ slots|tojson }};
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    const isAdmin = {{ is_admin|tojson|default('false') }};

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
    }

    function generateCalendar(year, month) {
        const calendar = document.getElementById('calendar');
        const title = document.getElementById('calendar-title');
        title.textContent = `${year}-${String(month + 1).padStart(2, '0')}`;

        calendar.innerHTML = '';
        const date = new Date(year, month, 1);
        const firstDay = date.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('day');
            calendar.appendChild(emptyCell);
        }

        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement('div');
            cell.classList.add('day');
            const header = document.createElement('div');
            header.classList.add('day-header');
            header.textContent = day;
            if (isAdmin) {
                header.classList.add('clickable');
                header.onclick = () => openAdminSetSlotForm(year, month + 1, day);
            }
            cell.appendChild(header);

            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            if (slots[dateString]) {
                // Sort slots by time
                slots[dateString].sort((a, b) => a.time.localeCompare(b.time));
                slots[dateString].forEach(slot => {
                    const slotDiv = document.createElement('div');
                    slotDiv.classList.add('slot');
                    slotDiv.textContent = `${slot.time} ${slot.reserved ? `(${slot.name})` : ''}`;
                    slotDiv.title = slot.reserved ? 'Reserved' : 'Available';
                    if (slot.reserved) {
                        slotDiv.classList.add('reserved');
                        if (isAdmin) {
                            slotDiv.onclick = () => openAdminCancelForm(slot);
                        } else {
                            slotDiv.onclick = () => openCancelForm(slot.reservation_id);
                        }
                    } else {
                        if (isAdmin) {
                            slotDiv.onclick = () => openAdminRemoveSlotForm(slot, dateString);
                        } else {
                            slotDiv.onclick = () => openReservationForm(dateString, slot.time);
                        }
                    }
                    cell.appendChild(slotDiv);
                });
            }

            calendar.appendChild(cell);
        }
    }

    function openReservationForm(date, time) {
        const datetime = `${date}T${time}`;
        document.getElementById('datetime').value = datetime;
        document.getElementById('reservationModal').style.display = 'block';
    }

    function openCancelForm(reservationId) {
        document.getElementById('cancel_reservation_id').value = reservationId;
        document.getElementById('cancelModal').style.display = 'block';
    }

    function openAdminCancelForm(slot) {
        document.getElementById('admin_cancel_reservation_id').value = slot.reservation_id;
        document.getElementById('adminReservationDetails').innerText = `Name: ${slot.name}\nPhone: ${slot.phone}\nTime: ${slot.time}`;
        document.getElementById('adminCancelModal').style.display = 'block';
    }

    function openAdminRemoveSlotForm(slot, dateString) {
        document.getElementById('admin_remove_slot_id').value = slot.slot_id;
        document.getElementById('adminRemoveSlotTitle').innerText = `Confirm Slot Removal (${dateString})`;
        document.getElementById('adminRemoveSlotDetails').innerText = `Time: ${slot.time}`;
        document.getElementById('adminRemoveSlotModal').style.display = 'block';
    }

    function openAdminSetSlotForm(year, month, day) {
        const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        document.getElementById('available_date').value = date;
        document.getElementById('adminSetSlotTitle').innerText = `Set Available Slot (${date})`;
        document.getElementById('adminSetSlotModal').style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function toggleEndDate() {
        var repeat = document.getElementById("repeat").value;
        var endDateField = document.getElementById("end_date_field");
        if (repeat === "none") {
            endDateField.style.display = "none";
        } else {
            endDateField.style.display = "block";
        }
    }

    function validateSetSlotForm() {
        var repeat = document.getElementById("repeat").value;
        var endDate = document.getElementById("end_date").value;
        if (repeat !== "none" && endDate === "") {
            alert("Please provide an end date for the repetition.");
            return false;
        }
        return true;
    }

    function cancelReservation(reservationId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/cancel';
        form.style.display = 'none';

        const reservationIdInput = document.createElement('input');
        reservationIdInput.name = 'reservation_id';
        reservationIdInput.value = reservationId;
        form.appendChild(reservationIdInput);

        document.body.appendChild(form);
        form.submit();
    }

    // Initialize the calendar with the current month
    generateCalendar(currentYear, currentMonth);
</script>
